# 多人协作技术实践

## 背景

xx系统是一个可视化开发网页的在线应用。用户通过拖拽web组件到布局组件来组合成一个页面组件，从而开发出一个网页。由于xx系统是一个在线应用，用户很快便提出了多人协同开发的需求。多人协作最核心的问题便是冲突处理，本文主要介绍在xx系统中是如何处理冲突问题的。

```text
读者可能会疑惑，业务千奇百怪，为什么可以通过组合组件来开发网页？
这就要从组件的3个核心概念说起，它们分别是`属性`、`插槽`和`事件`。
我们知道，组件的目的是复用，一个设计良好的组件会充分利用以上3个概念来解耦”变化“的业务。
比方说，组件的数据、样式选项可以做成属性；
有些组件天然地会包括子组件，这种情况可以预留插槽；
而组件的生命周期、点击动作则通常会定义成一系列事件；
反之，web组件通过耦合UI设计、交互逻辑以及可预见的插槽、事件；
即封装这些相对“稳定”的部分来达到复用（提高开发效率）的根本目的。
```

## 处理冲突的业界思路

首先我们调研了业界里处理冲突的思路：

### 思路1 避免冲突

通过在编辑区加锁来避免多人操作，从而消除产生冲突的可能性。这种思路本质上是伪多人协作，优点是流程上保证无冲突，缺点是用户体验不太好。

### 思路2 用户手动解决冲突

我们所熟知的Git/SVN都是采用这种方式——把冲突抛给用户手动解决。仔细想想这样做是因为：代码（纯文本）通常是有语义的，系统没有办法自动解决冲突。

可以认为，纯文本处理冲突的典型做法是：标记冲突让用户手动解决。

### 思路3 系统自动解决冲突

Google Docs等在线文档，均采用系统自动解决冲突。因为文档元素（富文本）底层的数据结构最终会序列化成XML/JSON/PB等格式进行传输存储，把冲突抛给用户解决，意味着用户需要理解富文本的内部表示。在实际业务中，这些内部表示应当要对用户透明。目前这类文档通过设计OT算法或设计CRDT数据结构来自动解决冲突。

可以认为，富文本处理冲突的典型做法是：系统自动解决冲突。

## 我们的业务场景该怎么做？

回顾一下xx系统是如何构建网页的。系统默认集成业界最受欢迎的web组件库，如element-ui，用户构建网页只需2步：

1、创建页面，在`画布`上拖拽组件进行组合配置，形成页面组件的初始状态；

2、创建函数，为组件编写事件处理`函数`，根据业务需求为页面组件更新状态；

首先，我们来看较为简单的函数多人协作，最后看复杂的画布多人协作。

## 函数多人协作

函数是纯文本，按理说我们应当采用手动解决冲突，这需要在xx系统中实现一套类似Git的代码拉取合并以及抛出冲突的机制，这不仅使“保存”操作交互冗长，实现成本也较高。反观xx系统的业务特点：纯文本是按函数拆分的，用户在短时间内协作同一函数的可能性较低。这种情况下给函数编辑加锁，用户体验影响不大，实现成本也不高。

函数编辑锁较为简单，我们先看看它是如何实现的——

![&#x51FD;&#x6570;&#x7F16;&#x8F91;&#x72B6;&#x6001;&#x673A;](https://github.com/haibazhang/lib/tree/668834d58add5e84aff62705a9b0c70b6b00aa4d/Users/zhanghaiba/lib/assets/image-20191208225721518.png)

在xx系统中，我们设计了如图所示的这样一个状态机来维护函数编辑状态。

（待续...）

## 画布多人协作

画布实质上是富文本，我们不能要求用户理解其内部表示，因此需要为此设计OT算法或CRDT数据结构。

xx系统采用_Redux_架构，架构示意图如下：

这种架构之下，“保存”功能示意图如下：

[source](https://github.com/haibazhang/lib/blob/master/src/web/proj/多人协作技术实践.md) \| [edit-online](https://github.com/haibazhang/lib/edit/master/src/web/proj/多人协作技术实践.md)

